# 9장 옵티마이저와 힌트

## 쿼리 실행 절차

1. 사용자로부터 요청된 SQL 문장을 잘게 쪼개서 MySQL 서버가 이해할 수 있는 수준으로 분리한다
2. SQL의 파싱 정보(파스 트리)를 확인하면서 어떤 테이블부터 일고 어떤 인덱스를 이용해 테이블을 읽을지 선택한다.
3. 두 번째 단계에서 결정된 테이블의 읽기 순서나 선택된 인덱스를 이용해 스토리지 엔진으로부터 데이터를 가져온다.

## 기본 데이터 처리

### 풀 테이블 스캔과 풀 인덱스 스캔

- 풀 테이블 스캔이 실행되면 처음 몇 개의 데이터 페이즈는 포그라운드 스레드 가 페이지 읽기를 실행하지만 특정 시점붜는 읽기 작업을 백그라운 드레드로 넘긴다. 이때 한 번에 최대 64개의 데이터 페이지까지 일거서 버퍼 풀에 저장해둔다. 포그라운드 스레드는 미리 버퍼 풀에 준비된 데이터를 가져다 사용하기만 하면 된다.
    
    → 리드 어헤드(Read ahead) 방식
    
- 풀 인덱스 스캔에서도 동일하게 사용된다.

### 병렬처리

- 하나의 쿼리를 여러 스레드가 작업을 나누어 동시에 처리한다는 것을 의미한다.

### ORDER BY 처리

- 인덱스 이용
    - 이미 정렬되어 있어서 빠르다
    - DML 작업이 느리다.
    - 인덱스를 위한 공간이 더 많이 필요하다.
    - 인덱스 개수가 늘어날 수록 버퍼 풀을 위한 메모리가 많이 필요하다
- Filesort 이용
    - 정렬해야 할 레코드가 많지 않으면 충분히 빠르다
    - 정렬 작업이 쿼리 실행 시 처리되므로 응답 속도가 느리다
- 소트 버퍼
    - 정렬을 수행하기 위해 별도의 메모리 공간을 할당받아서 사용하는데, 이 메모리 공간을 소트 버퍼라고 한다
    - 정렬해야 할 레코드의 건수가 소트 버퍼로 할당된 공간보다 크다면 이때는 MySQL은 정렬해야 할 레코드를 여러 조각으로 나눠서 처리하는데, 이 과정에서 임시 저장을 위해 디스크를 사용한다.
- 정렬 방식
    - 싱글 패스 정렬 방식
        - 소트 버퍼에 정렬 기준 칼럼을 포함해 SELECT 대상이 되는 컬럼 전부를 담아서 정렬을 수행하는 정렬 방식
    - 투 패스 정렬 방식
        - 정렬 대상 칼럼과 프라이머리 키 값만 소트 버퍼에 담아서 정렬을 수행하고, 정렬된 순서대로 다시 프라이머리 키로 테이블을 읽어서 SELECT할 칼럼을 가져오는 정렬 방식
- 정렬 처리 방법
    - 인덱스를 사용한 정렬
    - 조인에서 드라이빙 테이블만 정렬
    - 조인에서 조인 결과를 임시 테이블로 저장 후 정렬